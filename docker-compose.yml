# Mirqab Cloud Relay - Local Development
# Docker Compose for running all relay services locally
# Updated: 2026-01-28 - Phase 2 Hardening: Externalized secrets to .env
#   - MASTER_SERVER_URL = Customer's OffenSight instance (attack orchestration)
#   - Command Center = Mirqab management portal (licenses, feeds) - NOT used here
#
# SETUP: cp .env.template .env && ./scripts/generate-secrets.sh

services:
  # ===========================================
  # API GATEWAY - Security Layer
  # ===========================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: relay-api-gateway
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD:-}@redis:6379/0
      - REQUIRE_MTLS=${REQUIRE_MTLS:-false}
      - REQUIRE_SIGNATURE=${REQUIRE_SIGNATURE:-false}
      - DEBUG=${DEBUG:-true}
      - HTTP_C2_URL=http://http-c2:8080
      - WAF_TESTER_URL=http://waf-tester:8443
      - PAYLOAD_SERVER_URL=http://payload-service:8000
      - TRAEFIK_BACKEND_URL=http://traefik:80
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8000}
      - TEST_API_KEY=${TEST_API_KEY:-cloud-relay-test-api-key-2026}
      - TEST_API_SECRET=${TEST_API_SECRET:-cloud-relay-test-api-secret-2026}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - relay-net
    ports:
      - "8100:8000"  # API Gateway port
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-gateway.rule=PathPrefix(`/api/v1`)"
      - "traefik.http.routers.api-gateway.entrypoints=web"
      - "traefik.http.services.api-gateway.loadbalancer.server.port=8000"
      - "traefik.http.routers.api-gateway.priority=200"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===========================================
  # REVERSE PROXY
  # ===========================================
  traefik:
    image: traefik:v3.0
    container_name: relay-traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./traefik/certs:/etc/traefik/certs:ro
    ports:
      - "8180:80"      # HTTP
      - "8453:443"     # HTTPS (TLS 1.3)
      - "8280:8080"    # Traefik dashboard
    networks:
      - relay-net
    restart: unless-stopped

  # ===========================================
  # POSTGRESQL DATABASE
  # ===========================================
  relay-db:
    image: postgres:15-alpine
    container_name: relay-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-relay}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - POSTGRES_DB=${POSTGRES_DB:-relay}
    volumes:
      - relay-db-data:/var/lib/postgresql/data
    networks:
      - relay-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U relay -d relay"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================
  # PAYLOAD SERVICE (NEW - for file downloads)
  # ===========================================
  payload-service:
    build:
      context: ./services/payload-service
      dockerfile: Dockerfile
    container_name: relay-payload
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-relay}:${POSTGRES_PASSWORD:?err}@relay-db:5432/${POSTGRES_DB:-relay}
      - STORAGE_PATH=/payloads
      - LOG_LEVEL=INFO
    volumes:
      - payload-storage:/payloads
    depends_on:
      relay-db:
        condition: service_healthy
    networks:
      - relay-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.payload.rule=PathPrefix(`/download`) || PathPrefix(`/stage`) || PathPrefix(`/payloads`)"
      - "traefik.http.routers.payload.entrypoints=web"
      - "traefik.http.services.payload.loadbalancer.server.port=8000"
      - "traefik.http.routers.payload.priority=100"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ===========================================
  # HTTP C2 SERVICE
  # ===========================================
  http-c2:
    build:
      context: ./services/http-c2
      dockerfile: Dockerfile
    container_name: relay-http-c2
    environment:
      - ENVIRONMENT=local
      - MASTER_SERVER_URL=http://host.docker.internal:8000  # OffenSight instance
      - SIGNING_KEY=${SIGNING_KEY:?Set SIGNING_KEY in .env}
      - STORAGE_BACKEND=local
    networks:
      - relay-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.http-c2.rule=PathPrefix(`/beacon`) || PathPrefix(`/exfil`) || PathPrefix(`/test`) || PathPrefix(`/download`) || PathPrefix(`/stage`) || PathPrefix(`/health`)"
      - "traefik.http.routers.http-c2.entrypoints=web"
      - "traefik.http.services.http-c2.loadbalancer.server.port=8080"
      - "traefik.http.routers.http-c2.priority=50"
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/health', timeout=2)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ===========================================
  # SMTP PHISHING SERVICE
  # ===========================================
  smtp-phishing:
    build:
      context: ./services/smtp-phishing
      dockerfile: Dockerfile
    container_name: relay-smtp-phishing
    environment:
      - PHISHING_ENVIRONMENT=local
      - PHISHING_COMMAND_CENTER_URL=http://host.docker.internal:8000
      - PHISHING_SIGNING_KEY=${PHISHING_SIGNING_KEY:?Set PHISHING_SIGNING_KEY in .env}
      - PHISHING_SMTP_HOST=mailhog
      - PHISHING_SMTP_PORT=1025
      - PHISHING_SMTP_USE_TLS=false
      - PHISHING_SERVICE_URL=http://localhost/phishing
      - PHISHING_SMTP_FROM_DOMAIN=phishing.local
    networks:
      - relay-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.smtp.rule=PathPrefix(`/phishing`) || PathPrefix(`/track`) || PathPrefix(`/landing`)"
      - "traefik.http.routers.smtp.entrypoints=web"
      - "traefik.http.services.smtp.loadbalancer.server.port=8081"
      # Rewrite /phishing prefix
      - "traefik.http.middlewares.smtp-strip.stripprefix.prefixes=/phishing"
      - "traefik.http.routers.smtp.middlewares=smtp-strip"
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8081/health', timeout=2)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ===========================================
  # MAILHOG - Local SMTP Server for Testing
  # ===========================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: relay-mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI
    networks:
      - relay-net
    restart: unless-stopped

  # ===========================================
  # REDIS - Session/Cache (optional)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: relay-redis
    command: >
      sh -c "redis-server
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      $${REDIS_PASSWORD:+--requirepass $${REDIS_PASSWORD}}"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    networks:
      - relay-net
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ${REDIS_PASSWORD:+-a $REDIS_PASSWORD} ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================
  # WAF TESTER SERVICE (Hybrid - Context-Aware)
  # ===========================================
  waf-tester:
    build:
      context: ./services/waf-tester
      dockerfile: Dockerfile
    container_name: relay-waf-tester
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-relay}:${POSTGRES_PASSWORD:?err}@relay-db:5432/${POSTGRES_DB:-relay}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - LOG_LEVEL=info
      - ENABLE_LLM_ANALYSIS=true
      # - OPENAI_API_KEY=${OPENAI_API_KEY}  # Optional for LLM fallback
    networks:
      - relay-net
    depends_on:
      relay-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.waf-tester.rule=PathPrefix(`/waf`) || PathPrefix(`/health`)"
      - "traefik.http.routers.waf-tester.entrypoints=web"
      - "traefik.http.services.waf-tester.loadbalancer.server.port=8443"
      - "traefik.http.routers.waf-tester.priority=90"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ===========================================
  # DVWA - Vulnerable Web App for WAF Testing
  # ===========================================
  dvwa:
    image: vulnerables/web-dvwa:latest
    container_name: relay-dvwa
    environment:
      - RECAPTCHA_PRIV_KEY=
      - RECAPTCHA_PUB_KEY=
      - SECURITY_LEVEL=low
      - PHPIDS_ENABLED=0
    networks:
      - relay-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dvwa.rule=PathPrefix(`/dvwa`)"
      - "traefik.http.routers.dvwa.entrypoints=web"
      - "traefik.http.services.dvwa.loadbalancer.server.port=80"
      - "traefik.http.middlewares.dvwa-strip.stripprefix.prefixes=/dvwa"
      - "traefik.http.routers.dvwa.middlewares=dvwa-strip"
    restart: unless-stopped

  # ===========================================
  # C2 GATEWAY - Unified C2 API with Safety Controls
  # ===========================================
  c2-gateway:
    build:
      context: ./services/c2-gateway
      dockerfile: Dockerfile
    container_name: relay-c2-gateway
    environment:
      - CLOUD_RELAY_HOST=${CLOUD_RELAY_HOST:-192.168.100.67}
      - CLOUD_RELAY_DOMAIN=${CLOUD_RELAY_DOMAIN:-relay.local}
      - SLIVER_HOST=sliver
      - SLIVER_PORT=31337
      - MSF_HOST=metasploit
      - MSF_PORT=4444
      - LOG_LEVEL=INFO
    volumes:
      - c2-payloads:/payloads
    # Note: Sliver/Metasploit are optional - c2-gateway works standalone with simulated payloads
    # depends_on:
    #   - sliver
    #   - metasploit
    networks:
      - relay-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.c2-gateway.rule=PathPrefix(`/api/v1/payloads`) || PathPrefix(`/api/v1/sessions`) || PathPrefix(`/api/v1/c2`) || PathPrefix(`/c2-payloads`) || PathPrefix(`/sliver`) || PathPrefix(`/msf`)"
      - "traefik.http.routers.c2-gateway.entrypoints=web"
      - "traefik.http.services.c2-gateway.loadbalancer.server.port=8000"
      - "traefik.http.routers.c2-gateway.priority=95"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ===========================================
  # SLIVER C2 SERVER
  # Real C2 framework for MITRE T1071.001/T1071.004
  # ===========================================
  sliver:
    image: ghcr.io/bishopfox/sliver:latest
    container_name: relay-sliver
    environment:
      - SLIVER_NO_MULTIPLAYER=true
    volumes:
      - sliver-data:/home/sliver/.sliver
      - c2-payloads:/payloads
    ports:
      - "31337:31337"   # gRPC API
      - "8443:443"      # HTTPS implant listener
      - "8888:8888"     # HTTP implant listener
      - "5353:53/udp"   # DNS implant listener
    networks:
      - relay-net
    labels:
      - "traefik.enable=true"
      # Sliver HTTPS listener
      - "traefik.http.routers.sliver-https.rule=PathPrefix(`/sliver/implant`)"
      - "traefik.http.routers.sliver-https.entrypoints=web"
      - "traefik.http.services.sliver-https.loadbalancer.server.port=443"
      - "traefik.http.routers.sliver-https.priority=85"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "31337"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===========================================
  # METASPLOIT FRAMEWORK
  # Real C2 framework for MITRE T1071.001/T1095
  # ===========================================
  metasploit:
    image: metasploitframework/metasploit-framework:latest
    container_name: relay-metasploit
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-relay}:${POSTGRES_PASSWORD:?err}@relay-db:5432/msf
    volumes:
      - msf-data:/root/.msf4
      - c2-payloads:/payloads
    ports:
      - "4444:4444"     # Default handler
      - "4445:4445"     # HTTPS handler
      - "5555:5555"     # Additional handler
    depends_on:
      relay-db:
        condition: service_healthy
    networks:
      - relay-net
    # Start with RPC daemon for API access
    command: ["./msfconsole", "-q", "-x", "load msgrpc ServerHost=0.0.0.0 Pass=msf"]
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "55553"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

networks:
  relay-net:
    driver: bridge

volumes:
  relay-data:
  relay-db-data:
  payload-storage:
  c2-payloads:       # Shared C2 payload storage
  sliver-data:       # Sliver server data
  msf-data:          # Metasploit data
