# Mirqab Cloud Relay - Alertmanager Configuration
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
      # SMTP settings for email alerts
      smtp_smarthost: 'smtp.mirqab.io:587'
      smtp_from: 'alerts@mirqab.io'
      smtp_auth_username: '${SMTP_USERNAME}'
      smtp_auth_password: '${SMTP_PASSWORD}'

      # Slack settings
      slack_api_url: '${SLACK_WEBHOOK_URL}'

      # PagerDuty
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

    # Templates
    templates:
      - '/etc/alertmanager/template/*.tmpl'

    # Routing tree
    route:
      group_by: ['alertname', 'tenant_id', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default-receiver'

      routes:
        # Critical alerts go to PagerDuty and Slack
        - match:
            severity: critical
          receiver: 'critical-alerts'
          continue: true

        # Tenant-specific routing
        - match_re:
            tenant_id: '.+'
          receiver: 'tenant-alerts'
          group_by: ['tenant_id', 'alertname']

        # Operator alerts
        - match:
            alertname: OperatorDown
          receiver: 'ops-team'

        # License alerts to sales team
        - match_re:
            alertname: 'License.*'
          receiver: 'sales-team'

    # Receivers
    receivers:
      - name: 'default-receiver'
        email_configs:
          - to: 'ops@mirqab.io'
            send_resolved: true
        slack_configs:
          - channel: '#mirqab-alerts'
            send_resolved: true
            title: '{{ template "slack.default.title" . }}'
            text: '{{ template "slack.default.text" . }}'

      - name: 'critical-alerts'
        pagerduty_configs:
          - service_key: '${PAGERDUTY_SERVICE_KEY}'
            severity: critical
            description: '{{ template "pagerduty.default.description" . }}'
        slack_configs:
          - channel: '#mirqab-critical'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
            title: ':rotating_light: {{ .CommonAnnotations.summary }}'
            text: '{{ .CommonAnnotations.description }}'

      - name: 'tenant-alerts'
        webhook_configs:
          # Send to Command Center for tenant notification
          - url: 'http://command-center.mirqab-system.svc:8080/api/v1/alerts'
            send_resolved: true
            http_config:
              bearer_token: '${COMMAND_CENTER_TOKEN}'
        email_configs:
          - to: '{{ .CommonLabels.tenant_admin_email }}'
            send_resolved: true
            headers:
              Subject: '[Mirqab] Alert: {{ .CommonAnnotations.summary }}'

      - name: 'ops-team'
        email_configs:
          - to: 'ops@mirqab.io'
            send_resolved: true
        slack_configs:
          - channel: '#mirqab-ops'
            send_resolved: true

      - name: 'sales-team'
        email_configs:
          - to: 'sales@mirqab.io'
            send_resolved: true

    # Inhibition rules
    inhibit_rules:
      # Don't send warning if critical is firing for same tenant
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'tenant_id']

      # Don't alert on individual services if namespace is down
      - source_match:
          alertname: 'TenantNamespaceDown'
        target_match_re:
          alertname: 'Tenant.*'
        equal: ['tenant_id']
---
# Alert templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
data:
  mirqab.tmpl: |
    {{ define "slack.default.title" -}}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
    {{- end }}

    {{ define "slack.default.text" -}}
    {{ range .Alerts -}}
    *Alert:* {{ .Annotations.summary }}{{ if .Labels.tenant_id }} (Tenant: {{ .Labels.tenant_id }}){{ end }}
    *Description:* {{ .Annotations.description }}
    *Severity:* {{ .Labels.severity }}
    {{ if .Labels.namespace }}*Namespace:* {{ .Labels.namespace }}{{ end }}
    {{ end }}
    {{- end }}

    {{ define "pagerduty.default.description" -}}
    {{ .CommonAnnotations.summary }}
    {{- end }}

    {{ define "email.default.subject" -}}
    [{{ .Status | toUpper }}] {{ .CommonAnnotations.summary }}
    {{- end }}

    {{ define "email.default.html" -}}
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .firing { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .resolved { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .critical { border-left: 5px solid #dc3545; }
        .warning { border-left: 5px solid #ffc107; }
        .info { border-left: 5px solid #17a2b8; }
      </style>
    </head>
    <body>
      <h2>Mirqab Cloud Relay Alert</h2>
      {{ range .Alerts }}
      <div class="alert {{ .Status }} {{ .Labels.severity }}">
        <h3>{{ .Annotations.summary }}</h3>
        <p><strong>Description:</strong> {{ .Annotations.description }}</p>
        {{ if .Labels.tenant_id }}<p><strong>Tenant:</strong> {{ .Labels.tenant_id }}</p>{{ end }}
        <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
        <p><strong>Status:</strong> {{ .Status }}</p>
      </div>
      {{ end }}
    </body>
    </html>
    {{- end }}
